(()=>{"use strict";var t=1e-6,e="undefined"!=typeof Float32Array?Float32Array:Array;function s(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var i;i=new e(3),e!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0);class r{constructor(t){this.position=t,this.view=s(),this.update()}update(){const s=function(t,s,i){var r=new e(3);return r[0]=0,r[1]=s,r[2]=i,r}(0,this.position[1],this.position[2]);!function(e,s,i,r){var n,o,h,a,c,u,d,l,m,f,p=s[0],v=s[1],g=s[2],M=r[0],y=r[1],k=r[2],x=i[0],w=i[1],S=i[2];Math.abs(p-x)<t&&Math.abs(v-w)<t&&Math.abs(g-S)<t?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(e):(d=p-x,l=v-w,m=g-S,n=y*(m*=f=1/Math.hypot(d,l,m))-k*(l*=f),o=k*(d*=f)-M*m,h=M*l-y*d,(f=Math.hypot(n,o,h))?(n*=f=1/f,o*=f,h*=f):(n=0,o=0,h=0),a=l*h-m*o,c=m*n-d*h,u=d*o-l*n,(f=Math.hypot(a,c,u))?(a*=f=1/f,c*=f,u*=f):(a=0,c=0,u=0),e[0]=n,e[1]=a,e[2]=d,e[3]=0,e[4]=o,e[5]=c,e[6]=l,e[7]=0,e[8]=h,e[9]=u,e[10]=m,e[11]=0,e[12]=-(n*p+o*v+h*g),e[13]=-(a*p+c*v+u*g),e[14]=-(d*p+l*v+m*g),e[15]=1)}(this.view,this.position,s,[0,0,1])}get_view(){return this.view}pan(t,e){this.position[1]-=.01*t,this.position[2]+=.01*e,this.update()}}const n="struct TransformData{\r\n    model: mat4x4<f32>, // actual pos of model\r\n    view: mat4x4<f32>, // where shit is wrt camera\r\n    projection: mat4x4<f32> // perspective\r\n};\r\n\r\n\r\n@binding(0) @group(0) var<uniform> transformUBO : TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPostion: vec3<f32>, @location(1) vertexColor: vec3<f32>) -> Fragment {\r\n\r\n    var output : Fragment;\r\n    output.Position = transformUBO.projection * transformUBO.view * transformUBO.model * vec4<f32>(vertexPostion, 1.0);\r\n    // output.Position = vec4<f32>(vertexPostion, 0.0, 1.0);\r\n    output.Color = vec4<f32>(vertexColor, 1.0);\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) Color: vec4<f32>) -> @location(0) vec4<f32> {\r\n    return Color;\r\n}";var o=function(t,e,s,i){return new(s||(s=Promise))(function(r,n){function o(t){try{a(i.next(t))}catch(t){n(t)}}function h(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())})};class h{constructor(t){this.format="bgra8unorm",this.canvas=t}setup(){return o(this,void 0,void 0,function*(){var t,e;this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),this.device=yield null===(e=this.adapter)||void 0===e?void 0:e.requestDevice(),this.context=this.canvas.getContext("webgpu")})}configure(){this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}createPipeline(t){return o(this,void 0,void 0,function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]});this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const s=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({layout:s,vertex:{module:this.device.createShaderModule({code:n}),entryPoint:"vs_main",buffers:[t]},fragment:{module:this.device.createShaderModule({code:n}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"}})})}updateUniforms(t,e,s){this.device.queue.writeBuffer(this.uniformBuffer,0,t),this.device.queue.writeBuffer(this.uniformBuffer,64,e),this.device.queue.writeBuffer(this.uniformBuffer,128,s)}}class a{constructor(t,e,s,i,r,n=.1){this.erased=!1;const o=[],h=e[0],a=e[1],[c,u,d]=r,l=n,m=n;for(let t=0;t<=32;t++){const e=t/32*2*Math.PI,s=Math.cos(e)*l,i=Math.sin(e)*m;o.push([0,h+s,a+i,c,u,d]),o.push([0,h,a,c,u,d])}const f=new Float32Array(o.flat()),p=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,v={size:f.byteLength,usage:p,mappedAtCreation:!0};this.buffer=t.createBuffer(v),new Float32Array(this.buffer.getMappedRange()).set(f),this.buffer.unmap(),this.bufferLayout={arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}}destroy(){this.buffer.destroy()}}class c{constructor(t,e,s,i,r){this.points=t,this.radii=e,this.color=s,this.meshStartIndex=i,this.meshEndIndex=r}isPointOnStroke(t,e){var s;for(let i=0;i<this.points.length;i++){const[r,n]=this.points[i],o=t-r,h=e-n;if(o*o+h*h<((null!==(s=this.radii[i])&&void 0!==s?s:.05)+.05)**2)return!0}return!1}clone(){return new c(this.points.map(t=>[...t]),[...this.radii],[...this.color],this.meshStartIndex,this.meshEndIndex)}}class u{constructor(t,e,s,i=.07,r=.02){this.historyMgr=s,this.circleMeshes=[],this.strokes=[],this.currentStrokePoints=[],this.defaultBrushSize=.07,this.canvas=t,this.contextMgr=e,this.maxRadius=i,this.minRadius=r}getBufferLayout(){return new a(this.contextMgr.device,[0,0],this.canvas.width,this.canvas.height,[1,1,1]).bufferLayout}update(t,e,s,i,r,n,o,h=[.13,.157,.192]){var a;const u=Math.min(Math.max(o,.01),2.5),d=.7/(1+20*u*u),l=Math.min(Math.max(d,0),.95);if(this.defaultBrushSize=o,this.maxRadius=o,this.minRadius=o*(1-l),document.getElementById("maxsize").innerText=this.maxRadius.toFixed(3),document.getElementById("minsize").innerText=this.minRadius.toFixed(3),t&&!e){const t=r,e=n;if(null===t||null===e)this.currentStrokePoints.push([s,i]),this.drawCircle(s,i,h);else{const r=s-t,n=i-e,o=Math.sqrt(r*r+n*n),a=.02,c=Math.max(1,Math.floor(o/a));for(let s=0;s<=c;s++){const i=s/c,o=t+r*i,a=e+n*i;this.currentStrokePoints.push([o,a]),this.drawCircle(o,a,h)}}}if(!t&&!e&&this.currentStrokePoints.length>0){this.historyMgr.save(this.strokes);const t=this.currentStrokePoints.length,e=.15,s=[];this.circleMeshes.splice(this.circleMeshes.length-t);const i=this.circleMeshes.length;for(let i=0;i<t;i++){let r=1;i<t*e?r=i/(t*e):i>t*(1-e)&&(r=(t-i)/(t*e)),r=Math.max(0,Math.min(1,r));const n=this.minRadius+(this.maxRadius-this.minRadius)*r,[o,a]=this.currentStrokePoints[i];this.drawCircle(o,a,h,n),s.push(n)}const r=this.circleMeshes.length-1;this.strokes.push(new c(this.currentStrokePoints,s,h,i,r)),this.currentStrokePoints=[]}if(e&&t)for(let t=0;t<this.strokes.length;t++){const e=this.strokes[t];if(e.isPointOnStroke(s,i)){this.historyMgr.save(this.strokes);const s=e.meshEndIndex-e.meshStartIndex+2;for(let t=0;t<s;t++)null===(a=this.circleMeshes[e.meshStartIndex+t])||void 0===a||a.destroy();this.circleMeshes.splice(e.meshStartIndex,s),this.strokes.splice(t,1),this.recalculateStrokeMeshIndices();break}}}drawCircle(t,e,s,i=this.defaultBrushSize){const r=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,s,i);this.circleMeshes.push(r)}recalculateStrokeMeshIndices(){let t=0;for(const e of this.strokes){const s=e.points.length;e.meshStartIndex=t,e.meshEndIndex=t+s-1,t+=s}}render(t,e,s){for(const i of this.circleMeshes)i.erased||(t.setPipeline(e),t.setVertexBuffer(0,i.buffer),t.setBindGroup(0,s),t.draw(66,1,0,0));const i=document.getElementById("strokes");i&&(i.innerText=this.strokes.length.toString())}applyStrokes(t){for(const t of this.circleMeshes)t.destroy();this.circleMeshes=[],this.strokes=t,this.rebuildMeshes()}rebuildMeshes(){this.circleMeshes=[];for(const t of this.strokes)for(let e=0;e<t.points.length;e++){const[s,i]=t.points[e],r=t.radii[e];this.drawCircle(s,i,t.color,r)}this.recalculateStrokeMeshIndices()}}class d{constructor(t,e){this.canvas=t,this.contextMgr=e}update(t,e,s,i){this.mesh=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,[+s,0,+!s],i)}render(t,e,s,i){this.mesh&&i&&(t.setPipeline(e),t.setVertexBuffer(0,this.mesh.buffer),t.setBindGroup(0,s),t.draw(66,1,0,0))}}class l{constructor(){this.undoStack=[],this.redoStack=[]}save(t){const e=t.map(t=>t.clone());this.undoStack.push(e),this.redoStack=[]}undo(t){return 0===this.undoStack.length?null:(this.redoStack.push(t.map(t=>t.clone())),this.undoStack.pop())}redo(t){return 0===this.redoStack.length?null:(this.undoStack.push(t.map(t=>t.clone())),this.redoStack.pop())}clear(){this.undoStack=[],this.redoStack=[]}}var m=function(t,e,s,i){return new(s||(s=Promise))(function(r,n){function o(t){try{a(i.next(t))}catch(t){n(t)}}function h(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())})};class f{constructor(t){this.resolutionScale=2,this.zoomValue=10,this.canvas=t,this.deviceInfoElem=document.getElementById("dev-width"),this.camera=new r([this.zoomValue,0,0]),this.historyManager=new l,this.contextMgr=new h(t),this.strokeMgr=new u(t,this.contextMgr,this.historyManager,.07,.02),this.cursorRenderer=new d(t,this.contextMgr)}initialize(){return m(this,void 0,void 0,function*(){yield this.contextMgr.setup(),this.setCanvasResolution(),this.contextMgr.configure(),yield this.contextMgr.createPipeline(this.strokeMgr.getBufferLayout()),window.addEventListener("resize",()=>this.setCanvasResolution()),this.canvas.toDataURL("image/png")})}setCanvasResolution(){const t=this.resolutionScale;this.canvas.style.width="800px",this.canvas.style.height="600px",this.canvas.width=800*t,this.canvas.height=600*t,this.deviceInfoElem.innerText=`${this.canvas.width}x${this.canvas.height}`,this.contextMgr.configure()}render(t,e,i,r,n,o,h,a,c){return m(this,arguments,void 0,function*(t,e,i,r,n,o,h,a,c,u=.07,d=[.13,.157,.192]){document.getElementById("brushSize").innerText=u.toString(),t&&this.camera.pan(i,r),this.strokeMgr.update(e,c,n,o,h,a,u,d),this.cursorRenderer.update(n,o,c,u+.03);const l=s();!function(t,e,s,i,r){var n,o=1/Math.tan(e/2);t[0]=o/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(n=1/(i-r),t[10]=(r+i)*n,t[14]=2*r*i*n):(t[10]=-1,t[14]=-2*i)}(l,Math.PI/4,this.canvas.width/this.canvas.height,.001,1e3);const m=this.camera.get_view(),f=s();this.contextMgr.updateUniforms(f,m,l);const p=this.contextMgr.device,v=p.createCommandEncoder(),g=this.contextMgr.context.getCurrentTexture().createView(),M=v.beginRenderPass({colorAttachments:[{view:g,clearValue:{r:.93,g:.93,b:.93,a:1},loadOp:"clear",storeOp:"store"}]});this.strokeMgr.render(M,this.contextMgr.pipeline,this.contextMgr.bindGroup),this.cursorRenderer.render(M,this.contextMgr.pipeline,this.contextMgr.bindGroup,!t),M.end(),p.queue.submit([v.finish()])})}}class p{constructor(t){this.isCursorLocked=!1,this.isSpacePressed=!1,this.isLeftClicked=!1,this.isErasing=!1,this.skipNextClick=!1,this.zoomOut=!1,this.zoomIn=!1,this.takeScreenShot=!1,this.mouseX=0,this.mouseY=0,this.virtualMouseX=0,this.virtualMouseY=0,this.ndcX=0,this.ndcY=0,this.brushSize=.07,this.taperPercent=.15,this.brushColor=[.13,.157,.192],this.onKeyDown=t=>{this.keyLabel.innerText=t.code,"Space"===t.code&&(this.isSpacePressed=!0),"Minus"===t.code?this.zoomOut=!0:"Equal"===t.code&&(this.zoomIn=!0)},this.onKeyUp=t=>{this.keyLabel.innerText=`${t.code} released`,"Space"===t.code&&(this.isSpacePressed=!1),"KeyE"===t.code&&(this.isErasing=!this.isErasing,document.getElementById("erasing").innerText=this.isErasing.toString()),"Minus"===t.code?this.zoomOut=!1:"Equal"===t.code&&(this.zoomIn=!1),"Enter"===t.code&&(this.takeScreenShot=!0)},this.keyLabel=document.getElementById("key-down"),this.mouseXLabel=document.getElementById("mouse-x"),this.mouseYLabel=document.getElementById("mouse-y"),this.pointerLabel=document.getElementById("pointerlock");const e=document.getElementById("color-picker");e.addEventListener("input",()=>{const t=e.value,s=parseInt(t.substring(1,3),16),i=parseInt(t.substring(3,5),16),r=parseInt(t.substring(5,7),16);this.brushColor=[s/255,i/255,r/255],document.getElementById("color-r").innerText=s.toString(),document.getElementById("color-g").innerText=i.toString(),document.getElementById("color-b").innerText=r.toString(),document.getElementById("brushcolor").innerText=`[${s}, ${i}, ${r}]`}),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),document.addEventListener("pointerlockchange",()=>{this.isCursorLocked=document.pointerLockElement===t,this.isCursorLocked&&(this.skipNextClick=!0)}),t.onclick=()=>t.requestPointerLock(),t.addEventListener("mousedown",t=>{0===t.button&&(this.isLeftClicked=!0)}),t.addEventListener("mouseup",t=>{0===t.button&&(this.isLeftClicked=!1)}),t.addEventListener("mouseleave",()=>{this.isLeftClicked=!1});const s=document.getElementById("brush-size-slider");s.addEventListener("input",()=>{this.brushSize=parseFloat(s.value)}),t.addEventListener("mousemove",e=>this.onMouseMove(e,t))}onMouseMove(t,e){this.isCursorLocked&&(this.mouseX=t.movementX,this.mouseY=t.movementY,this.virtualMouseX+=t.movementX,this.virtualMouseY+=t.movementY,this.ndcX=10*this.virtualMouseX/e.width,this.ndcY=1-10*this.virtualMouseY/e.height,this.mouseXLabel.innerText=this.ndcX.toString(),this.mouseYLabel.innerText=this.ndcY.toString(),this.pointerLabel.innerText=(this.isSpacePressed&&this.isLeftClicked).toString())}}const v=document.getElementById("gfx-main"),g=new class{constructor(t){this.lastDrawX=null,this.lastDrawY=null,this.smoothedX=0,this.smoothedY=0,this.smoothedSpeed=0,this.zoomLevel=10,this.run=()=>{const t=this.input;if(t.takeScreenShot){t.takeScreenShot=!1,this.renderer.render(!0,!1,t.mouseX,t.mouseY,this.smoothedX,this.smoothedY,this.lastDrawX,this.lastDrawY,t.isErasing,t.brushSize,t.brushColor);const e=this.canvas.toDataURL("image/png"),s=document.createElement("a");s.href=e,s.download="screenshot.png",s.click()}t.zoomIn&&this.zoomLevel>1.5?this.zoomLevel-=.5:t.zoomOut&&(this.zoomLevel+=.5),this.renderer.camera.position[0]=this.zoomLevel,this.renderer.camera.update(),document.getElementById("zoom").innerText=this.zoomLevel.toString();const e=t.isLeftClicked&&t.isCursorLocked&&!t.skipNextClick&&!t.isSpacePressed;this.smoothedX=.55*this.smoothedX+.45*t.ndcX,this.smoothedY=.55*this.smoothedY+.45*t.ndcY,this.renderer.render(t.isSpacePressed&&t.isCursorLocked,e,t.mouseX,t.mouseY,this.smoothedX,this.smoothedY,this.lastDrawX,this.lastDrawY,t.isErasing,t.brushSize,t.brushColor),e?(this.lastDrawX=this.smoothedX,this.lastDrawY=this.smoothedY):(this.lastDrawX=null,this.lastDrawY=null),t.skipNextClick=!1,t.mouseX=0,t.mouseY=0,requestAnimationFrame(this.run)},this.canvas=t,this.renderer=new f(t),this.input=new p(t),this.renderer.camera.position[0]=this.zoomLevel}initialize(){return t=this,e=void 0,i=function*(){yield this.renderer.initialize(),window.addEventListener("keydown",t=>{if(t.ctrlKey&&"z"===t.key){t.preventDefault();const e=this.renderer.strokeMgr.historyMgr.undo(this.renderer.strokeMgr.strokes);e&&this.renderer.strokeMgr.applyStrokes(e)}if(t.ctrlKey&&"y"===t.key){t.preventDefault();const e=this.renderer.strokeMgr.historyMgr.redo(this.renderer.strokeMgr.strokes);e&&this.renderer.strokeMgr.applyStrokes(e)}})},new((s=void 0)||(s=Promise))(function(r,n){function o(t){try{a(i.next(t))}catch(t){n(t)}}function h(t){try{a(i.throw(t))}catch(t){n(t)}}function a(t){var e;t.done?r(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())});var t,e,s,i}}(v);g.initialize().then(()=>g.run())})();