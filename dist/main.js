(()=>{"use strict";const t="struct TransformData{\r\n    model: mat4x4<f32>, // actual pos of model\r\n    view: mat4x4<f32>, // where shit is wrt camera\r\n    projection: mat4x4<f32> // perspective\r\n};\r\n\r\n\r\n@binding(0) @group(0) var<uniform> transformUBO : TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPostion: vec3<f32>, @location(1) vertexColor: vec3<f32>) -> Fragment {\r\n\r\n    var output : Fragment;\r\n    output.Position = transformUBO.projection * transformUBO.view * transformUBO.model * vec4<f32>(vertexPostion, 1.0);\r\n    // output.Position = vec4<f32>(vertexPostion, 0.0, 1.0);\r\n    output.Color = vec4<f32>(vertexColor, 1.0);\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) Color: vec4<f32>) -> @location(0) vec4<f32> {\r\n    return Color;\r\n}";class e{constructor(t,e,i,s,n,r=.1){this.erased=!1;const o=[],h=e[0],a=e[1],[c,u,d]=n,l=r,f=r;for(let t=0;t<=32;t++){const e=t/32*2*Math.PI,i=Math.cos(e)*l,s=Math.sin(e)*f;o.push([0,h+i,a+s,c,u,d]),o.push([0,h,a,c,u,d])}const v=new Float32Array(o.flat()),m=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,p={size:v.byteLength,usage:m,mappedAtCreation:!0};this.buffer=t.createBuffer(p),new Float32Array(this.buffer.getMappedRange()).set(v),this.buffer.unmap(),this.bufferLayout={arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}}}var i=1e-6,s="undefined"!=typeof Float32Array?Float32Array:Array;function n(){var t=new s(16);return s!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var r;r=new s(3),s!=Float32Array&&(r[0]=0,r[1]=0,r[2]=0);class o{constructor(t){this.position=t,this.view=n(),this.update()}update(){const t=function(t,e,i){var n=new s(3);return n[0]=0,n[1]=e,n[2]=i,n}(0,this.position[1],this.position[2]);!function(t,e,s,n){var r,o,h,a,c,u,d,l,f,v,m=e[0],p=e[1],g=e[2],w=n[0],y=n[1],k=n[2],x=s[0],M=s[1],P=s[2];Math.abs(m-x)<i&&Math.abs(p-M)<i&&Math.abs(g-P)<i?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(t):(d=m-x,l=p-M,f=g-P,r=y*(f*=v=1/Math.hypot(d,l,f))-k*(l*=v),o=k*(d*=v)-w*f,h=w*l-y*d,(v=Math.hypot(r,o,h))?(r*=v=1/v,o*=v,h*=v):(r=0,o=0,h=0),a=l*h-f*o,c=f*r-d*h,u=d*o-l*r,(v=Math.hypot(a,c,u))?(a*=v=1/v,c*=v,u*=v):(a=0,c=0,u=0),t[0]=r,t[1]=a,t[2]=d,t[3]=0,t[4]=o,t[5]=c,t[6]=l,t[7]=0,t[8]=h,t[9]=u,t[10]=f,t[11]=0,t[12]=-(r*m+o*p+h*g),t[13]=-(a*m+c*p+u*g),t[14]=-(d*m+l*p+f*g),t[15]=1)}(this.view,this.position,t,[0,0,1])}get_view(){return this.view}pan(t,e){this.position[1]-=.01*t,this.position[2]+=.01*e,this.update()}}class h{constructor(t,e,i,s,n){this.points=t,this.radii=e,this.color=i,this.meshStartIndex=s,this.meshEndIndex=n}isPointOnStroke(t,e){var i;for(let s=0;s<this.points.length;s++){const[n,r]=this.points[s],o=t-n,h=e-r;if(o*o+h*h<((null!==(i=this.radii[s])&&void 0!==i?i:.05)+.05)**2)return!0}return!1}}var a=function(t,e,i,s){return new(i||(i=Promise))(function(n,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function h(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())})};class c{constructor(t){this.resolutionScale=2,this.circleMeshes=[],this.defaultBrushSize=.1,this.currentStrokePoints=[],this.canvas=t,this.strokes=[],this.device_deets=document.getElementById("dev-width"),this.device_deets.innerText=this.canvas.width.toString()+"x"+this.canvas.height.toString(),this.camera=new o([10,0,0]),this.circleCount=0}setCanvasResolution(){const t=this.resolutionScale;this.canvas.style.width="800px",this.canvas.style.height="600px",this.canvas.width=800*t,this.canvas.height=600*t,this.device_deets.innerText=`${this.canvas.width}x${this.canvas.height}`,this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}Initialize(){return a(this,void 0,void 0,function*(){yield this.setupDevice(),this.setCanvasResolution(),this.drawCircle(0,0,[.93,.93,.93],0),yield this.makePipeline(),window.addEventListener("resize",()=>this.setCanvasResolution())})}setupDevice(){return a(this,void 0,void 0,function*(){var t,e;this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),this.device=yield null===(e=this.adapter)||void 0===e?void 0:e.requestDevice(),this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})})}makePipeline(){return a(this,void 0,void 0,function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]});this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const i=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({vertex:{module:this.device.createShaderModule({code:t}),entryPoint:"vs_main",buffers:[this.circleMeshes[0].bufferLayout]},fragment:{module:this.device.createShaderModule({code:t}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"},layout:i})})}drawCircle(t,i,s,n=this.defaultBrushSize){const r=new e(this.device,[t,i],this.canvas.width,this.canvas.height,s,n);this.circleMeshes.push(r),this.circleCount+=1}render(t,i,s,r,o,c,u,d,l){return a(this,void 0,void 0,function*(){document.getElementById("strokes").innerText=this.strokes.length.toString();const a=[.13,.157,.192];if(this.defaultBrushSize=.07,t&&this.camera.pan(s,r),i&&!l){const t=u,e=d;if(null===t||null===e)this.currentStrokePoints.push([o,c]),this.drawCircle(o,c,a,this.defaultBrushSize);else{const i=o-t,s=c-e,n=Math.sqrt(i*i+s*s),r=.02,h=Math.max(1,Math.floor(n/r));for(let n=0;n<=h;n++){const r=n/h,o=t+i*r,c=e+s*r;this.currentStrokePoints.push([o,c]),this.drawCircle(o,c,a,this.defaultBrushSize)}}u=o,d=c}if(!i&&!l&&this.currentStrokePoints.length>0){const t=this.currentStrokePoints.length,e=.02,i=.075,s=.15,n=[];this.circleMeshes.splice(this.circleMeshes.length-t),this.circleCount-=t;const r=this.circleMeshes.length;for(let r=0;r<t;r++){let o=1;r<t*s?o=r/(t*s):r>t*(1-s)&&(o=(t-r)/(t*s)),o=Math.min(1,Math.max(0,o));const h=e+(i-e)*o,[c,u]=this.currentStrokePoints[r];n.push(h),this.drawCircle(c,u,a,h)}const o=this.circleMeshes.length-1;this.strokes.push(new h(this.currentStrokePoints,n,a,r,o)),this.currentStrokePoints=[]}if(l&&i)for(let t=0;t<this.strokes.length;t++){const e=this.strokes[t];if(e.isPointOnStroke(o,c)){const i=e.meshEndIndex-e.meshStartIndex+2;this.circleMeshes.splice(e.meshStartIndex,i),this.circleCount-=i,this.strokes.splice(t,1);let s=0;for(const t of this.strokes){const e=t.points.length;t.meshStartIndex=s,t.meshEndIndex=s+e-1,s+=e}break}}this.cursorMesh&&(this.cursorMesh=void 0),this.cursorMesh=new e(this.device,[o,c],this.canvas.width,this.canvas.height,[+l,0,+!l]);const f=n();!function(t,e,i,s,n){var r,o=1/Math.tan(e/2);t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(r=1/(s-n),t[10]=(n+s)*r,t[14]=2*n*s*r):(t[10]=-1,t[14]=-2*s)}(f,Math.PI/4,this.canvas.width/this.canvas.height,.001,1e3);const v=this.camera.get_view(),m=n();this.device.queue.writeBuffer(this.uniformBuffer,0,m),this.device.queue.writeBuffer(this.uniformBuffer,64,v),this.device.queue.writeBuffer(this.uniformBuffer,128,f);const p=this.device.createCommandEncoder(),g=this.context.getCurrentTexture().createView(),w=p.beginRenderPass({colorAttachments:[{view:g,clearValue:{r:.93,g:.93,b:.93,a:1},loadOp:"clear",storeOp:"store"}]});for(const t of this.circleMeshes)t.erased||(w.setPipeline(this.pipeline),w.setVertexBuffer(0,t.buffer),w.setBindGroup(0,this.bindGroup),w.draw(66,1,0,0));!t&&this.cursorMesh&&(w.setPipeline(this.pipeline),w.setVertexBuffer(0,this.cursorMesh.buffer),w.setBindGroup(0,this.bindGroup),w.draw(66,1,0,0)),w.end(),this.device.queue.submit([p.finish()])})}}class u{constructor(t){this.isCursorLocked=!1,this.isSpacePressed=!1,this.isLeftClicked=!1,this.isErasing=!1,this.skipNextClick=!1,this.mouseX=0,this.mouseY=0,this.virtualMouseX=0,this.virtualMouseY=0,this.ndcX=0,this.ndcY=0,this.onKeyDown=t=>{this.keyLabel.innerText=t.code,"Space"===t.code&&(this.isSpacePressed=!0)},this.onKeyUp=t=>{this.keyLabel.innerText=`${t.code} released`,"Space"===t.code&&(this.isSpacePressed=!1),"KeyE"===t.code&&(this.isErasing=!this.isErasing,document.getElementById("erasing").innerText=this.isErasing.toString())},this.keyLabel=document.getElementById("key-down"),this.mouseXLabel=document.getElementById("mouse-x"),this.mouseYLabel=document.getElementById("mouse-y"),this.pointerLabel=document.getElementById("pointerlock"),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),document.addEventListener("pointerlockchange",()=>{this.isCursorLocked=document.pointerLockElement===t,this.isCursorLocked&&(this.skipNextClick=!0)}),t.onclick=()=>t.requestPointerLock(),t.addEventListener("mousedown",t=>{0===t.button&&(this.isLeftClicked=!0)}),t.addEventListener("mouseup",t=>{0===t.button&&(this.isLeftClicked=!1)}),t.addEventListener("mouseleave",()=>{this.isLeftClicked=!1}),t.addEventListener("mousemove",e=>this.onMouseMove(e,t))}onMouseMove(t,e){this.isCursorLocked&&(this.mouseX=t.movementX,this.mouseY=t.movementY,this.virtualMouseX+=t.movementX,this.virtualMouseY+=t.movementY,this.ndcX=10*this.virtualMouseX/e.width,this.ndcY=1-10*this.virtualMouseY/e.height,this.mouseXLabel.innerText=this.mouseX.toString(),this.mouseYLabel.innerText=this.mouseY.toString(),this.pointerLabel.innerText=(this.isSpacePressed&&this.isLeftClicked).toString())}}const d=document.getElementById("gfx-main"),l=new class{constructor(t){this.lastDrawX=null,this.lastDrawY=null,this.smoothedX=0,this.smoothedY=0,this.smoothedSpeed=0,this.run=()=>{const t=this.input,e=t.isLeftClicked&&t.isCursorLocked&&!t.skipNextClick&&!t.isSpacePressed;this.smoothedX=.55*this.smoothedX+.45*t.ndcX,this.smoothedY=.55*this.smoothedY+.45*t.ndcY,this.renderer.render(t.isSpacePressed&&t.isCursorLocked,e,t.mouseX,t.mouseY,this.smoothedX,this.smoothedY,this.lastDrawX,this.lastDrawY,t.isErasing),e?(this.lastDrawX=this.smoothedX,this.lastDrawY=this.smoothedY):(this.lastDrawX=null,this.lastDrawY=null),t.skipNextClick=!1,t.mouseX=0,t.mouseY=0,requestAnimationFrame(this.run)},this.canvas=t,this.renderer=new c(t),this.input=new u(t)}initialize(){return t=this,e=void 0,s=function*(){yield this.renderer.Initialize()},new((i=void 0)||(i=Promise))(function(n,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function h(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())});var t,e,i,s}}(d);l.initialize().then(()=>l.run())})();