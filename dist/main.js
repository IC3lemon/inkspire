(()=>{"use strict";var t=1e-6,e="undefined"!=typeof Float32Array?Float32Array:Array;function s(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var i;i=new e(3),e!=Float32Array&&(i[0]=0,i[1]=0,i[2]=0);class n{constructor(t){this.position=t,this.view=s(),this.update()}update(){const s=function(t,s,i){var n=new e(3);return n[0]=0,n[1]=s,n[2]=i,n}(0,this.position[1],this.position[2]);!function(e,s,i,n){var r,o,h,a,c,u,d,l,f,m,v=s[0],p=s[1],g=s[2],w=n[0],x=n[1],M=n[2],y=i[0],k=i[1],P=i[2];Math.abs(v-y)<t&&Math.abs(p-k)<t&&Math.abs(g-P)<t?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(e):(d=v-y,l=p-k,f=g-P,r=x*(f*=m=1/Math.hypot(d,l,f))-M*(l*=m),o=M*(d*=m)-w*f,h=w*l-x*d,(m=Math.hypot(r,o,h))?(r*=m=1/m,o*=m,h*=m):(r=0,o=0,h=0),a=l*h-f*o,c=f*r-d*h,u=d*o-l*r,(m=Math.hypot(a,c,u))?(a*=m=1/m,c*=m,u*=m):(a=0,c=0,u=0),e[0]=r,e[1]=a,e[2]=d,e[3]=0,e[4]=o,e[5]=c,e[6]=l,e[7]=0,e[8]=h,e[9]=u,e[10]=f,e[11]=0,e[12]=-(r*v+o*p+h*g),e[13]=-(a*v+c*p+u*g),e[14]=-(d*v+l*p+f*g),e[15]=1)}(this.view,this.position,s,[0,0,1])}get_view(){return this.view}pan(t,e){this.position[1]-=.01*t,this.position[2]+=.01*e,this.update()}}const r="struct TransformData{\r\n    model: mat4x4<f32>, // actual pos of model\r\n    view: mat4x4<f32>, // where shit is wrt camera\r\n    projection: mat4x4<f32> // perspective\r\n};\r\n\r\n\r\n@binding(0) @group(0) var<uniform> transformUBO : TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPostion: vec3<f32>, @location(1) vertexColor: vec3<f32>) -> Fragment {\r\n\r\n    var output : Fragment;\r\n    output.Position = transformUBO.projection * transformUBO.view * transformUBO.model * vec4<f32>(vertexPostion, 1.0);\r\n    // output.Position = vec4<f32>(vertexPostion, 0.0, 1.0);\r\n    output.Color = vec4<f32>(vertexColor, 1.0);\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) Color: vec4<f32>) -> @location(0) vec4<f32> {\r\n    return Color;\r\n}";var o=function(t,e,s,i){return new(s||(s=Promise))(function(n,r){function o(t){try{a(i.next(t))}catch(t){r(t)}}function h(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())})};class h{constructor(t){this.format="bgra8unorm",this.canvas=t}setup(){return o(this,void 0,void 0,function*(){var t,e;this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),this.device=yield null===(e=this.adapter)||void 0===e?void 0:e.requestDevice(),this.context=this.canvas.getContext("webgpu")})}configure(){this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}createPipeline(t){return o(this,void 0,void 0,function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]});this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const s=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({layout:s,vertex:{module:this.device.createShaderModule({code:r}),entryPoint:"vs_main",buffers:[t]},fragment:{module:this.device.createShaderModule({code:r}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"}})})}updateUniforms(t,e,s){this.device.queue.writeBuffer(this.uniformBuffer,0,t),this.device.queue.writeBuffer(this.uniformBuffer,64,e),this.device.queue.writeBuffer(this.uniformBuffer,128,s)}}class a{constructor(t,e,s,i,n,r=.1){this.erased=!1;const o=[],h=e[0],a=e[1],[c,u,d]=n,l=r,f=r;for(let t=0;t<=32;t++){const e=t/32*2*Math.PI,s=Math.cos(e)*l,i=Math.sin(e)*f;o.push([0,h+s,a+i,c,u,d]),o.push([0,h,a,c,u,d])}const m=new Float32Array(o.flat()),v=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,p={size:m.byteLength,usage:v,mappedAtCreation:!0};this.buffer=t.createBuffer(p),new Float32Array(this.buffer.getMappedRange()).set(m),this.buffer.unmap(),this.bufferLayout={arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}}}class c{constructor(t,e,s,i,n){this.points=t,this.radii=e,this.color=s,this.meshStartIndex=i,this.meshEndIndex=n}isPointOnStroke(t,e){var s;for(let i=0;i<this.points.length;i++){const[n,r]=this.points[i],o=t-n,h=e-r;if(o*o+h*h<((null!==(s=this.radii[i])&&void 0!==s?s:.05)+.05)**2)return!0}return!1}}class u{constructor(t,e,s=.07){this.circleMeshes=[],this.strokes=[],this.currentStrokePoints=[],this.canvas=t,this.contextMgr=e,this.defaultBrushSize=s}getBufferLayout(){return new a(this.contextMgr.device,[0,0],this.canvas.width,this.canvas.height,[1,1,1]).bufferLayout}update(t,e,s,i,n,r){const o=[.13,.157,.192];if(t&&!e){const t=n,e=r;if(null===t||null===e)this.currentStrokePoints.push([s,i]),this.drawCircle(s,i,o);else{const n=s-t,r=i-e,h=Math.sqrt(n*n+r*r),a=.02,c=Math.max(1,Math.floor(h/a));for(let s=0;s<=c;s++){const i=s/c,h=t+n*i,a=e+r*i;this.currentStrokePoints.push([h,a]),this.drawCircle(h,a,o)}}}if(!t&&!e&&this.currentStrokePoints.length>0){const t=this.currentStrokePoints.length,e=.15,s=[];this.circleMeshes.splice(this.circleMeshes.length-t);const i=this.circleMeshes.length;for(let i=0;i<t;i++){let n=1;i<t*e?n=i/(t*e):i>t*(1-e)&&(n=(t-i)/(t*e)),n=Math.max(0,Math.min(1,n));const r=.02+(this.defaultBrushSize-.02)*n,[h,a]=this.currentStrokePoints[i];this.drawCircle(h,a,o,r),s.push(r)}const n=this.circleMeshes.length-1;this.strokes.push(new c(this.currentStrokePoints,s,o,i,n)),this.currentStrokePoints=[]}if(e&&t)for(let t=0;t<this.strokes.length;t++){const e=this.strokes[t];if(e.isPointOnStroke(s,i)){const s=e.meshEndIndex-e.meshStartIndex+2;this.circleMeshes.splice(e.meshStartIndex,s),this.strokes.splice(t,1),this.recalculateStrokeMeshIndices();break}}}drawCircle(t,e,s,i=this.defaultBrushSize){const n=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,s,i);this.circleMeshes.push(n)}recalculateStrokeMeshIndices(){let t=0;for(const e of this.strokes){const s=e.points.length;e.meshStartIndex=t,e.meshEndIndex=t+s-1,t+=s}}render(t,e,s){for(const i of this.circleMeshes)i.erased||(t.setPipeline(e),t.setVertexBuffer(0,i.buffer),t.setBindGroup(0,s),t.draw(66,1,0,0));const i=document.getElementById("strokes");i&&(i.innerText=this.strokes.length.toString())}}class d{constructor(t,e){this.canvas=t,this.contextMgr=e}update(t,e,s){this.mesh=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,[Number(s),0,Number(!s)],.1)}render(t,e,s,i){this.mesh&&i&&(t.setPipeline(e),t.setVertexBuffer(0,this.mesh.buffer),t.setBindGroup(0,s),t.draw(66,1,0,0))}}var l=function(t,e,s,i){return new(s||(s=Promise))(function(n,r){function o(t){try{a(i.next(t))}catch(t){r(t)}}function h(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())})};class f{constructor(t){this.resolutionScale=2,this.canvas=t,this.deviceInfoElem=document.getElementById("dev-width"),this.camera=new n([10,0,0]),this.contextMgr=new h(t),this.strokeMgr=new u(t,this.contextMgr),this.cursorRenderer=new d(t,this.contextMgr)}initialize(){return l(this,void 0,void 0,function*(){yield this.contextMgr.setup(),this.setCanvasResolution(),this.contextMgr.configure(),yield this.contextMgr.createPipeline(this.strokeMgr.getBufferLayout()),window.addEventListener("resize",()=>this.setCanvasResolution())})}setCanvasResolution(){const t=this.resolutionScale;this.canvas.style.width="800px",this.canvas.style.height="600px",this.canvas.width=800*t,this.canvas.height=600*t,this.deviceInfoElem.innerText=`${this.canvas.width}x${this.canvas.height}`,this.contextMgr.configure()}render(t,e,i,n,r,o,h,a,c){return l(this,void 0,void 0,function*(){t&&this.camera.pan(i,n),this.strokeMgr.update(e,c,r,o,h,a),this.cursorRenderer.update(r,o,c);const u=s();!function(t,e,s,i,n){var r,o=1/Math.tan(e/2);t[0]=o/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(r=1/(i-n),t[10]=(n+i)*r,t[14]=2*n*i*r):(t[10]=-1,t[14]=-2*i)}(u,Math.PI/4,this.canvas.width/this.canvas.height,.001,1e3);const d=this.camera.get_view(),l=s();this.contextMgr.updateUniforms(l,d,u);const f=this.contextMgr.device,m=f.createCommandEncoder(),v=this.contextMgr.context.getCurrentTexture().createView(),p=m.beginRenderPass({colorAttachments:[{view:v,clearValue:{r:.93,g:.93,b:.93,a:1},loadOp:"clear",storeOp:"store"}]});this.strokeMgr.render(p,this.contextMgr.pipeline,this.contextMgr.bindGroup),this.cursorRenderer.render(p,this.contextMgr.pipeline,this.contextMgr.bindGroup,!t),p.end(),f.queue.submit([m.finish()])})}}class m{constructor(t){this.isCursorLocked=!1,this.isSpacePressed=!1,this.isLeftClicked=!1,this.isErasing=!1,this.skipNextClick=!1,this.mouseX=0,this.mouseY=0,this.virtualMouseX=0,this.virtualMouseY=0,this.ndcX=0,this.ndcY=0,this.onKeyDown=t=>{this.keyLabel.innerText=t.code,"Space"===t.code&&(this.isSpacePressed=!0)},this.onKeyUp=t=>{this.keyLabel.innerText=`${t.code} released`,"Space"===t.code&&(this.isSpacePressed=!1),"KeyE"===t.code&&(this.isErasing=!this.isErasing,document.getElementById("erasing").innerText=this.isErasing.toString())},this.keyLabel=document.getElementById("key-down"),this.mouseXLabel=document.getElementById("mouse-x"),this.mouseYLabel=document.getElementById("mouse-y"),this.pointerLabel=document.getElementById("pointerlock"),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),document.addEventListener("pointerlockchange",()=>{this.isCursorLocked=document.pointerLockElement===t,this.isCursorLocked&&(this.skipNextClick=!0)}),t.onclick=()=>t.requestPointerLock(),t.addEventListener("mousedown",t=>{0===t.button&&(this.isLeftClicked=!0)}),t.addEventListener("mouseup",t=>{0===t.button&&(this.isLeftClicked=!1)}),t.addEventListener("mouseleave",()=>{this.isLeftClicked=!1}),t.addEventListener("mousemove",e=>this.onMouseMove(e,t))}onMouseMove(t,e){this.isCursorLocked&&(this.mouseX=t.movementX,this.mouseY=t.movementY,this.virtualMouseX+=t.movementX,this.virtualMouseY+=t.movementY,this.ndcX=10*this.virtualMouseX/e.width,this.ndcY=1-10*this.virtualMouseY/e.height,this.mouseXLabel.innerText=this.mouseX.toString(),this.mouseYLabel.innerText=this.mouseY.toString(),this.pointerLabel.innerText=(this.isSpacePressed&&this.isLeftClicked).toString())}}const v=document.getElementById("gfx-main"),p=new class{constructor(t){this.lastDrawX=null,this.lastDrawY=null,this.smoothedX=0,this.smoothedY=0,this.smoothedSpeed=0,this.run=()=>{const t=this.input,e=t.isLeftClicked&&t.isCursorLocked&&!t.skipNextClick&&!t.isSpacePressed;this.smoothedX=.55*this.smoothedX+.45*t.ndcX,this.smoothedY=.55*this.smoothedY+.45*t.ndcY,this.renderer.render(t.isSpacePressed&&t.isCursorLocked,e,t.mouseX,t.mouseY,this.smoothedX,this.smoothedY,this.lastDrawX,this.lastDrawY,t.isErasing),e?(this.lastDrawX=this.smoothedX,this.lastDrawY=this.smoothedY):(this.lastDrawX=null,this.lastDrawY=null),t.skipNextClick=!1,t.mouseX=0,t.mouseY=0,requestAnimationFrame(this.run)},this.canvas=t,this.renderer=new f(t),this.input=new m(t)}initialize(){return t=this,e=void 0,i=function*(){yield this.renderer.initialize()},new((s=void 0)||(s=Promise))(function(n,r){function o(t){try{a(i.next(t))}catch(t){r(t)}}function h(t){try{a(i.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s(function(t){t(e)})).then(o,h)}a((i=i.apply(t,e||[])).next())});var t,e,s,i}}(v);p.initialize().then(()=>p.run())})();