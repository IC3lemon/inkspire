(()=>{"use strict";var t=1e-6,e="undefined"!=typeof Float32Array?Float32Array:Array;function i(){var t=new e(16);return e!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var s;s=new e(3),e!=Float32Array&&(s[0]=0,s[1]=0,s[2]=0);class n{constructor(t){this.position=t,this.view=i(),this.update()}update(){const i=function(t,i,s){var n=new e(3);return n[0]=0,n[1]=i,n[2]=s,n}(0,this.position[1],this.position[2]);!function(e,i,s,n){var r,o,h,a,c,u,d,l,f,m,v=i[0],p=i[1],g=i[2],x=n[0],y=n[1],M=n[2],w=s[0],k=s[1],b=s[2];Math.abs(v-w)<t&&Math.abs(p-k)<t&&Math.abs(g-b)<t?function(t){t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1}(e):(d=v-w,l=p-k,f=g-b,r=y*(f*=m=1/Math.hypot(d,l,f))-M*(l*=m),o=M*(d*=m)-x*f,h=x*l-y*d,(m=Math.hypot(r,o,h))?(r*=m=1/m,o*=m,h*=m):(r=0,o=0,h=0),a=l*h-f*o,c=f*r-d*h,u=d*o-l*r,(m=Math.hypot(a,c,u))?(a*=m=1/m,c*=m,u*=m):(a=0,c=0,u=0),e[0]=r,e[1]=a,e[2]=d,e[3]=0,e[4]=o,e[5]=c,e[6]=l,e[7]=0,e[8]=h,e[9]=u,e[10]=f,e[11]=0,e[12]=-(r*v+o*p+h*g),e[13]=-(a*v+c*p+u*g),e[14]=-(d*v+l*p+f*g),e[15]=1)}(this.view,this.position,i,[0,0,1])}get_view(){return this.view}pan(t,e){this.position[1]-=.01*t,this.position[2]+=.01*e,this.update()}}const r="struct TransformData{\r\n    model: mat4x4<f32>, // actual pos of model\r\n    view: mat4x4<f32>, // where shit is wrt camera\r\n    projection: mat4x4<f32> // perspective\r\n};\r\n\r\n\r\n@binding(0) @group(0) var<uniform> transformUBO : TransformData;\r\n\r\nstruct Fragment {\r\n    @builtin(position) Position : vec4<f32>,\r\n    @location(0) Color : vec4<f32>\r\n};\r\n\r\n@vertex\r\nfn vs_main(@location(0) vertexPostion: vec3<f32>, @location(1) vertexColor: vec3<f32>) -> Fragment {\r\n\r\n    var output : Fragment;\r\n    output.Position = transformUBO.projection * transformUBO.view * transformUBO.model * vec4<f32>(vertexPostion, 1.0);\r\n    // output.Position = vec4<f32>(vertexPostion, 0.0, 1.0);\r\n    output.Color = vec4<f32>(vertexColor, 1.0);\r\n\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn fs_main(@location(0) Color: vec4<f32>) -> @location(0) vec4<f32> {\r\n    return Color;\r\n}";var o=function(t,e,i,s){return new(i||(i=Promise))(function(n,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function h(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())})};class h{constructor(t){this.format="bgra8unorm",this.canvas=t}setup(){return o(this,void 0,void 0,function*(){var t,e;this.adapter=yield null===(t=navigator.gpu)||void 0===t?void 0:t.requestAdapter(),this.device=yield null===(e=this.adapter)||void 0===e?void 0:e.requestDevice(),this.context=this.canvas.getContext("webgpu")})}configure(){this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}createPipeline(t){return o(this,void 0,void 0,function*(){this.uniformBuffer=this.device.createBuffer({size:192,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST});const e=this.device.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.VERTEX,buffer:{}}]});this.bindGroup=this.device.createBindGroup({layout:e,entries:[{binding:0,resource:{buffer:this.uniformBuffer}}]});const i=this.device.createPipelineLayout({bindGroupLayouts:[e]});this.pipeline=this.device.createRenderPipeline({layout:i,vertex:{module:this.device.createShaderModule({code:r}),entryPoint:"vs_main",buffers:[t]},fragment:{module:this.device.createShaderModule({code:r}),entryPoint:"fs_main",targets:[{format:this.format}]},primitive:{topology:"triangle-strip"}})})}updateUniforms(t,e,i){this.device.queue.writeBuffer(this.uniformBuffer,0,t),this.device.queue.writeBuffer(this.uniformBuffer,64,e),this.device.queue.writeBuffer(this.uniformBuffer,128,i)}}class a{constructor(t,e,i,s,n,r=.1){this.erased=!1;const o=[],h=e[0],a=e[1],[c,u,d]=n,l=r,f=r;for(let t=0;t<=32;t++){const e=t/32*2*Math.PI,i=Math.cos(e)*l,s=Math.sin(e)*f;o.push([0,h+i,a+s,c,u,d]),o.push([0,h,a,c,u,d])}const m=new Float32Array(o.flat()),v=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST,p={size:m.byteLength,usage:v,mappedAtCreation:!0};this.buffer=t.createBuffer(p),new Float32Array(this.buffer.getMappedRange()).set(m),this.buffer.unmap(),this.bufferLayout={arrayStride:24,attributes:[{shaderLocation:0,format:"float32x3",offset:0},{shaderLocation:1,format:"float32x3",offset:12}]}}}class c{constructor(t,e,i,s,n){this.points=t,this.radii=e,this.color=i,this.meshStartIndex=s,this.meshEndIndex=n}isPointOnStroke(t,e){var i;for(let s=0;s<this.points.length;s++){const[n,r]=this.points[s],o=t-n,h=e-r;if(o*o+h*h<((null!==(i=this.radii[s])&&void 0!==i?i:.05)+.05)**2)return!0}return!1}}class u{constructor(t,e,i=.07,s=.02){this.circleMeshes=[],this.strokes=[],this.currentStrokePoints=[],this.defaultBrushSize=.07,this.canvas=t,this.contextMgr=e,this.maxRadius=i,this.minRadius=s}getBufferLayout(){return new a(this.contextMgr.device,[0,0],this.canvas.width,this.canvas.height,[1,1,1]).bufferLayout}update(t,e,i,s,n,r,o,h=[.13,.157,.192]){const a=Math.min(Math.max(o,.01),2.5),u=.7/(1+20*a*a),d=Math.min(Math.max(u,0),.95);if(this.defaultBrushSize=o,this.maxRadius=o,this.minRadius=o*(1-d),document.getElementById("maxsize").innerText=this.maxRadius.toFixed(3),document.getElementById("minsize").innerText=this.minRadius.toFixed(3),t&&!e){const t=n,e=r;if(null===t||null===e)this.currentStrokePoints.push([i,s]),this.drawCircle(i,s,h);else{const n=i-t,r=s-e,o=Math.sqrt(n*n+r*r),a=.02,c=Math.max(1,Math.floor(o/a));for(let i=0;i<=c;i++){const s=i/c,o=t+n*s,a=e+r*s;this.currentStrokePoints.push([o,a]),this.drawCircle(o,a,h)}}}if(!t&&!e&&this.currentStrokePoints.length>0){const t=this.currentStrokePoints.length,e=.15,i=[];this.circleMeshes.splice(this.circleMeshes.length-t);const s=this.circleMeshes.length;for(let s=0;s<t;s++){let n=1;s<t*e?n=s/(t*e):s>t*(1-e)&&(n=(t-s)/(t*e)),n=Math.max(0,Math.min(1,n));const r=this.minRadius+(this.maxRadius-this.minRadius)*n,[o,a]=this.currentStrokePoints[s];this.drawCircle(o,a,h,r),i.push(r)}const n=this.circleMeshes.length-1;this.strokes.push(new c(this.currentStrokePoints,i,h,s,n)),this.currentStrokePoints=[]}if(e&&t)for(let t=0;t<this.strokes.length;t++){const e=this.strokes[t];if(e.isPointOnStroke(i,s)){const i=e.meshEndIndex-e.meshStartIndex+2;this.circleMeshes.splice(e.meshStartIndex,i),this.strokes.splice(t,1),this.recalculateStrokeMeshIndices();break}}}drawCircle(t,e,i,s=this.defaultBrushSize){const n=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,i,s);this.circleMeshes.push(n)}recalculateStrokeMeshIndices(){let t=0;for(const e of this.strokes){const i=e.points.length;e.meshStartIndex=t,e.meshEndIndex=t+i-1,t+=i}}render(t,e,i){for(const s of this.circleMeshes)s.erased||(t.setPipeline(e),t.setVertexBuffer(0,s.buffer),t.setBindGroup(0,i),t.draw(66,1,0,0));const s=document.getElementById("strokes");s&&(s.innerText=this.strokes.length.toString())}}class d{constructor(t,e){this.canvas=t,this.contextMgr=e}update(t,e,i,s){this.mesh=new a(this.contextMgr.device,[t,e],this.canvas.width,this.canvas.height,[+i,0,+!i],s)}render(t,e,i,s){this.mesh&&s&&(t.setPipeline(e),t.setVertexBuffer(0,this.mesh.buffer),t.setBindGroup(0,i),t.draw(66,1,0,0))}}var l=function(t,e,i,s){return new(i||(i=Promise))(function(n,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function h(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())})};class f{constructor(t){this.resolutionScale=2,this.canvas=t,this.deviceInfoElem=document.getElementById("dev-width"),this.camera=new n([10,0,0]),this.contextMgr=new h(t),this.strokeMgr=new u(t,this.contextMgr,.07,.02),this.cursorRenderer=new d(t,this.contextMgr)}initialize(){return l(this,void 0,void 0,function*(){yield this.contextMgr.setup(),this.setCanvasResolution(),this.contextMgr.configure(),yield this.contextMgr.createPipeline(this.strokeMgr.getBufferLayout()),window.addEventListener("resize",()=>this.setCanvasResolution())})}setCanvasResolution(){const t=this.resolutionScale;this.canvas.style.width="800px",this.canvas.style.height="600px",this.canvas.width=800*t,this.canvas.height=600*t,this.deviceInfoElem.innerText=`${this.canvas.width}x${this.canvas.height}`,this.contextMgr.configure()}render(t,e,s,n,r,o,h,a,c){return l(this,arguments,void 0,function*(t,e,s,n,r,o,h,a,c,u=.07,d=[.13,.157,.192]){document.getElementById("brushSize").innerText=u.toString(),t&&this.camera.pan(s,n),this.strokeMgr.update(e,c,r,o,h,a,u,d),this.cursorRenderer.update(r,o,c,u+.03);const l=i();!function(t,e,i,s,n){var r,o=1/Math.tan(e/2);t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=n&&n!==1/0?(r=1/(s-n),t[10]=(n+s)*r,t[14]=2*n*s*r):(t[10]=-1,t[14]=-2*s)}(l,Math.PI/4,this.canvas.width/this.canvas.height,.001,1e3);const f=this.camera.get_view(),m=i();this.contextMgr.updateUniforms(m,f,l);const v=this.contextMgr.device,p=v.createCommandEncoder(),g=this.contextMgr.context.getCurrentTexture().createView(),x=p.beginRenderPass({colorAttachments:[{view:g,clearValue:{r:.93,g:.93,b:.93,a:1},loadOp:"clear",storeOp:"store"}]});this.strokeMgr.render(x,this.contextMgr.pipeline,this.contextMgr.bindGroup),this.cursorRenderer.render(x,this.contextMgr.pipeline,this.contextMgr.bindGroup,!t),x.end(),v.queue.submit([p.finish()])})}}class m{constructor(t){this.isCursorLocked=!1,this.isSpacePressed=!1,this.isLeftClicked=!1,this.isErasing=!1,this.skipNextClick=!1,this.mouseX=0,this.mouseY=0,this.virtualMouseX=0,this.virtualMouseY=0,this.ndcX=0,this.ndcY=0,this.brushSize=.07,this.taperPercent=.15,this.brushColor=[.13,.157,.192],this.onKeyDown=t=>{this.keyLabel.innerText=t.code,"Space"===t.code&&(this.isSpacePressed=!0)},this.onKeyUp=t=>{this.keyLabel.innerText=`${t.code} released`,"Space"===t.code&&(this.isSpacePressed=!1),"KeyE"===t.code&&(this.isErasing=!this.isErasing,document.getElementById("erasing").innerText=this.isErasing.toString())},this.keyLabel=document.getElementById("key-down"),this.mouseXLabel=document.getElementById("mouse-x"),this.mouseYLabel=document.getElementById("mouse-y"),this.pointerLabel=document.getElementById("pointerlock");const e=document.getElementById("color-picker");e.addEventListener("input",()=>{const t=e.value,i=parseInt(t.substring(1,3),16),s=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16);this.brushColor=[i/255,s/255,n/255],document.getElementById("color-r").innerText=i.toString(),document.getElementById("color-g").innerText=s.toString(),document.getElementById("color-b").innerText=n.toString(),document.getElementById("brushcolor").innerText=`[${i}, ${s}, ${n}]`}),document.addEventListener("keydown",this.onKeyDown),document.addEventListener("keyup",this.onKeyUp),document.addEventListener("pointerlockchange",()=>{this.isCursorLocked=document.pointerLockElement===t,this.isCursorLocked&&(this.skipNextClick=!0)}),t.onclick=()=>t.requestPointerLock(),t.addEventListener("mousedown",t=>{0===t.button&&(this.isLeftClicked=!0)}),t.addEventListener("mouseup",t=>{0===t.button&&(this.isLeftClicked=!1)}),t.addEventListener("mouseleave",()=>{this.isLeftClicked=!1});const i=document.getElementById("brush-size-slider");i.addEventListener("input",()=>{this.brushSize=parseFloat(i.value)}),t.addEventListener("mousemove",e=>this.onMouseMove(e,t))}onMouseMove(t,e){this.isCursorLocked&&(this.mouseX=t.movementX,this.mouseY=t.movementY,this.virtualMouseX+=t.movementX,this.virtualMouseY+=t.movementY,this.ndcX=10*this.virtualMouseX/e.width,this.ndcY=1-10*this.virtualMouseY/e.height,this.mouseXLabel.innerText=this.ndcX.toString(),this.mouseYLabel.innerText=this.ndcY.toString(),this.pointerLabel.innerText=(this.isSpacePressed&&this.isLeftClicked).toString())}}const v=document.getElementById("gfx-main"),p=new class{constructor(t){this.lastDrawX=null,this.lastDrawY=null,this.smoothedX=0,this.smoothedY=0,this.smoothedSpeed=0,this.run=()=>{const t=this.input,e=t.isLeftClicked&&t.isCursorLocked&&!t.skipNextClick&&!t.isSpacePressed;this.smoothedX=.55*this.smoothedX+.45*t.ndcX,this.smoothedY=.55*this.smoothedY+.45*t.ndcY,this.renderer.render(t.isSpacePressed&&t.isCursorLocked,e,t.mouseX,t.mouseY,this.smoothedX,this.smoothedY,this.lastDrawX,this.lastDrawY,t.isErasing,t.brushSize,t.brushColor),e?(this.lastDrawX=this.smoothedX,this.lastDrawY=this.smoothedY):(this.lastDrawX=null,this.lastDrawY=null),t.skipNextClick=!1,t.mouseX=0,t.mouseY=0,requestAnimationFrame(this.run)},this.canvas=t,this.renderer=new f(t),this.input=new m(t)}initialize(){return t=this,e=void 0,s=function*(){yield this.renderer.initialize()},new((i=void 0)||(i=Promise))(function(n,r){function o(t){try{a(s.next(t))}catch(t){r(t)}}function h(t){try{a(s.throw(t))}catch(t){r(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(o,h)}a((s=s.apply(t,e||[])).next())});var t,e,i,s}}(v);p.initialize().then(()=>p.run())})();